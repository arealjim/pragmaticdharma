<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="robots" content="noindex, nofollow">
<meta name="referrer" content="no-referrer">
<title>Admin - Pragmatic Dharma</title>
<style>
  :root { --bg: #1a1a2e; --fg: #e0e0e0; --accent: #64ffda; --muted: #888; --border: #333; --card-bg: #16213e; --err: #ff6b6b; }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--fg); line-height: 1.6; padding: 2rem; }
  a { color: var(--accent); text-decoration: none; }
  a:hover { text-decoration: underline; }
  .back { display: inline-block; margin-bottom: 1.5rem; color: var(--muted); font-size: 0.9rem; }
  h1 { font-size: 1.5rem; font-weight: 400; color: var(--accent); margin-bottom: 0.5rem; }
  h2 { font-size: 1.15rem; font-weight: 400; color: var(--accent); margin: 2rem 0 0.75rem; }
  .container { max-width: 900px; margin: 0 auto; }
  .msg { margin: 0.5rem 0; font-size: 0.9rem; }
  .msg.ok { color: var(--accent); }
  .msg.err { color: var(--err); }
  table { width: 100%; border-collapse: collapse; background: var(--card-bg); border: 1px solid var(--border); border-radius: 8px; overflow: hidden; margin-bottom: 1rem; }
  th, td { text-align: left; padding: 0.6rem 0.75rem; border-bottom: 1px solid var(--border); font-size: 0.9rem; }
  th { color: var(--muted); font-weight: 500; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.05em; }
  td { color: var(--fg); }
  tr:last-child td { border-bottom: none; }
  .note-cell { max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; color: var(--muted); font-size: 0.85rem; }
  .status-badge { font-size: 0.8rem; padding: 0.1rem 0.4rem; border-radius: 3px; }
  .status-badge.approved { background: rgba(100,255,218,0.15); color: var(--accent); }
  .status-badge.pending { background: rgba(255,193,7,0.15); color: #ffc107; }
  .status-badge.rejected { background: rgba(255,107,107,0.15); color: var(--err); }
  .btn { padding: 0.3rem 0.7rem; border: none; border-radius: 4px; font-family: inherit; font-size: 0.8rem; cursor: pointer; font-weight: 500; }
  .btn:disabled { opacity: 0.5; cursor: not-allowed; }
  .btn-approve { background: var(--accent); color: var(--bg); }
  .btn-approve:hover { opacity: 0.9; }
  .btn-reject { background: transparent; border: 1px solid var(--err); color: var(--err); }
  .btn-reject:hover { background: rgba(255,107,107,0.1); }
  .btn-group { display: flex; gap: 0.4rem; }
  .empty { color: var(--muted); font-size: 0.9rem; padding: 1rem; text-align: center; }
  .loading { color: var(--muted); font-size: 0.9rem; }
  .add-user-form { display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap; }
  .add-user-form input { background: var(--card-bg); border: 1px solid var(--border); border-radius: 4px; padding: 0.4rem 0.6rem; color: var(--fg); font-family: inherit; font-size: 0.85rem; }
  .add-user-form input:focus { outline: none; border-color: var(--accent); }
  .add-user-form input::placeholder { color: var(--muted); }
  .project-badges { display: flex; gap: 0.3rem; flex-wrap: wrap; }
  .project-badge { font-size: 0.75rem; padding: 0.15rem 0.45rem; border-radius: 3px; cursor: pointer; border: 1px solid var(--border); user-select: none; transition: opacity 0.15s, background 0.15s; }
  .project-badge.active { background: rgba(100,255,218,0.2); color: var(--accent); border-color: var(--accent); }
  .project-badge.inactive { background: transparent; color: var(--muted); opacity: 0.5; }
  .project-badge:hover { opacity: 1; }
  .project-badge.saving { opacity: 0.3; pointer-events: none; }
  .toggle-row { display: flex; align-items: center; justify-content: space-between; padding: 0.6rem 0; border-bottom: 1px solid var(--border); }
  .toggle-row:last-child { border-bottom: none; }
  .toggle-label { font-size: 0.9rem; }
  .toggle-switch { position: relative; width: 40px; height: 22px; cursor: pointer; }
  .toggle-switch input { opacity: 0; width: 0; height: 0; }
  .toggle-slider { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: var(--border); border-radius: 11px; transition: background 0.2s; }
  .toggle-slider:before { content: ''; position: absolute; width: 16px; height: 16px; left: 3px; bottom: 3px; background: var(--fg); border-radius: 50%; transition: transform 0.2s; }
  .toggle-switch input:checked + .toggle-slider { background: var(--accent); }
  .toggle-switch input:checked + .toggle-slider:before { transform: translateX(18px); background: var(--bg); }
  .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.75rem; margin-bottom: 1rem; }
  .stat-card { background: var(--card-bg); border: 1px solid var(--border); border-radius: 8px; padding: 1rem; }
  .stat-card .stat-label { font-size: 0.8rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.05em; }
  .stat-card .stat-value { font-size: 1.5rem; font-weight: 600; color: var(--accent); margin-top: 0.25rem; }
  .stat-card .stat-sub { font-size: 0.8rem; color: var(--muted); margin-top: 0.15rem; }
  .project-stats-section { margin-bottom: 1.5rem; }
  .project-stats-header { font-size: 0.95rem; color: var(--fg); margin-bottom: 0.5rem; font-weight: 500; }
  @media (prefers-color-scheme: light) {
    :root { --bg: #fafafa; --fg: #222; --accent: #0d7377; --muted: #666; --border: #ddd; --card-bg: #fff; }
  }
  @media (max-width: 600px) {
    body { padding: 1rem; }
    th, td { padding: 0.4rem 0.5rem; font-size: 0.8rem; }
    .note-cell { max-width: 100px; }
  }
</style>
</head>
<body>
<div class="container">
  <a class="back" href="/">&larr; Pragmatic Dharma</a>
  <h1>Admin</h1>
  <div id="feedback" class="msg"></div>

  <h2>Open Beta</h2>
  <div id="beta-section" style="background:var(--card-bg);border:1px solid var(--border);border-radius:8px;padding:0.5rem 1rem;margin-bottom:1rem;">
    <div class="toggle-row">
      <span class="toggle-label">Global (all projects)</span>
      <label class="toggle-switch"><input type="checkbox" id="beta-global" onchange="toggleBeta('open_beta',this.checked)"><span class="toggle-slider"></span></label>
    </div>
    <div class="toggle-row">
      <span class="toggle-label">Health Tracker</span>
      <label class="toggle-switch"><input type="checkbox" id="beta-health" onchange="toggleBeta('open_beta:health',this.checked)"><span class="toggle-slider"></span></label>
    </div>
    <div class="toggle-row">
      <span class="toggle-label">Psychic Shield</span>
      <label class="toggle-switch"><input type="checkbox" id="beta-shield" onchange="toggleBeta('open_beta:shield',this.checked)"><span class="toggle-slider"></span></label>
    </div>
    <div class="toggle-row">
      <span class="toggle-label">Ego Assessment</span>
      <label class="toggle-switch"><input type="checkbox" id="beta-ego-assessment" onchange="toggleBeta('open_beta:ego-assessment',this.checked)"><span class="toggle-slider"></span></label>
    </div>
  </div>

  <h2>Project Stats</h2>
  <div id="stats-section"><span class="loading">Loading...</span></div>

  <h2>Pending Requests</h2>
  <div id="pending-section"><span class="loading">Loading...</span></div>

  <h2>Add User</h2>
  <div class="add-user-form">
    <input type="text" id="add-name" placeholder="Name" autocomplete="off">
    <input type="email" id="add-email" placeholder="Email" autocomplete="off">
    <button class="btn btn-approve" onclick="createUser()">Add</button>
  </div>
  <div id="add-feedback" class="msg"></div>

  <h2>All Users</h2>
  <div id="users-section"><span class="loading">Loading...</span></div>
</div>

<script>
(function() {
  // Check admin session
  fetch('/api/session', { credentials: 'include' })
    .then(function(r) { return r.json(); })
    .then(function(data) {
      if (!data || !data.user || data.user.role !== 'admin') {
        window.location.href = '/login';
        return;
      }
      loadConfig();
      loadProjectStats();
      loadPending();
      loadUsers();
    })
    .catch(function() { window.location.href = '/login'; });

  function loadConfig() {
    fetch('/api/admin/config', { credentials: 'include' })
      .then(function(r) { return r.json(); })
      .then(function(data) {
        if (!data.config) return;
        var c = data.config;
        var el;
        el = document.getElementById('beta-global'); if (el) el.checked = c.open_beta === 'true';
        el = document.getElementById('beta-health'); if (el) el.checked = c['open_beta:health'] === 'true';
        el = document.getElementById('beta-shield'); if (el) el.checked = c['open_beta:shield'] === 'true';
        el = document.getElementById('beta-ego-assessment'); if (el) el.checked = c['open_beta:ego-assessment'] === 'true';
      });
  }

  window.toggleBeta = function(key, enabled) {
    var body = {};
    body[key] = enabled ? 'true' : 'false';
    fetch('/api/admin/config', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body),
      credentials: 'include'
    });
  };

  function loadProjectStats() {
    var section = document.getElementById('stats-section');
    var html = '';

    // Fetch stats from all three sources in parallel
    var shieldDone = false, egoDone = false, healthDone = false;
    var shieldHtml = '', egoHtml = '', healthHtml = '';

    function renderStats() {
      if (!shieldDone || !egoDone || !healthDone) return;
      section.innerHTML = shieldHtml + egoHtml + healthHtml || '<p class="empty">No stats available.</p>';
    }

    // Shield stats (from local access logs)
    fetch('/api/admin/access-logs?project=shield&limit=50', { credentials: 'include' })
      .then(function(r) { return r.json(); })
      .then(function(data) {
        var logs = data.logs || [];
        var uniqueUsers = {};
        logs.forEach(function(l) { if (l.user_email) uniqueUsers[l.user_email] = true; });
        shieldHtml = '<div class="project-stats-section"><div class="project-stats-header">Psychic Shield</div><div class="stats-grid">'
          + '<div class="stat-card"><div class="stat-label">Recent Accesses</div><div class="stat-value">' + logs.length + '</div></div>'
          + '<div class="stat-card"><div class="stat-label">Unique Users</div><div class="stat-value">' + Object.keys(uniqueUsers).length + '</div></div>'
          + '</div></div>';
      })
      .catch(function() { shieldHtml = ''; })
      .finally(function() { shieldDone = true; renderStats(); });

    // Ego Assessment stats (cross-origin)
    fetch('https://psychology.pragmaticdharma.org/api/admin/stats', { credentials: 'include' })
      .then(function(r) { return r.json(); })
      .then(function(data) {
        egoHtml = '<div class="project-stats-section"><div class="project-stats-header">Ego Assessment</div><div class="stats-grid">'
          + '<div class="stat-card"><div class="stat-label">Users</div><div class="stat-value">' + (data.totalUsers || 0) + '</div></div>'
          + '<div class="stat-card"><div class="stat-label">Completions</div><div class="stat-value">' + (data.totalCompletions || 0) + '</div></div>'
          + '<div class="stat-card"><div class="stat-label">Active (7d)</div><div class="stat-value">' + (data.activeUsersLast7Days || 0) + '</div></div>'
          + '<div class="stat-card"><div class="stat-label">Leaderboard</div><div class="stat-value">' + (data.leaderboardEntries || 0) + '</div></div>'
          + '</div></div>';
      })
      .catch(function() { egoHtml = '<div class="project-stats-section"><div class="project-stats-header">Ego Assessment</div><p class="empty">Unable to fetch stats.</p></div>'; })
      .finally(function() { egoDone = true; renderStats(); });

    // Health Tracker stats (cross-origin)
    fetch('https://health.pragmaticdharma.org/admin/api/usage', { credentials: 'include' })
      .then(function(r) { return r.json(); })
      .then(function(data) {
        var users = data.per_user || [];
        var daily = data.daily || [];
        healthHtml = '<div class="project-stats-section"><div class="project-stats-header">Health Tracker</div><div class="stats-grid">'
          + '<div class="stat-card"><div class="stat-label">Active Users</div><div class="stat-value">' + users.length + '</div></div>'
          + '<div class="stat-card"><div class="stat-label">Recent Days</div><div class="stat-value">' + daily.length + '</div></div>'
          + '</div></div>';
      })
      .catch(function() { healthHtml = '<div class="project-stats-section"><div class="project-stats-header">Health Tracker</div><p class="empty">Unable to fetch stats.</p></div>'; })
      .finally(function() { healthDone = true; renderStats(); });
  }

  function loadPending() {
    fetch('/api/admin/pending', { credentials: 'include' })
      .then(function(r) { return r.json(); })
      .then(function(data) {
        var section = document.getElementById('pending-section');
        if (!data.users || data.users.length === 0) {
          section.innerHTML = '<p class="empty">No pending requests.</p>';
          return;
        }
        var html = '<table><thead><tr><th>Name</th><th>Email</th><th>Note</th><th>Date</th><th>Actions</th></tr></thead><tbody>';
        data.users.forEach(function(u) {
          html += '<tr>'
            + '<td>' + esc(u.name) + '</td>'
            + '<td>' + esc(u.email) + '</td>'
            + '<td class="note-cell" title="' + esc(u.note || '') + '">' + esc(u.note || '-') + '</td>'
            + '<td>' + formatDate(u.created_at) + '</td>'
            + '<td><div class="btn-group">'
            + '<button class="btn btn-approve" onclick="doAction(\'approve\',\'' + esc(u.email) + '\',this)">Approve</button>'
            + '<button class="btn btn-reject" onclick="doAction(\'reject\',\'' + esc(u.email) + '\',this)">Reject</button>'
            + '</div></td></tr>';
        });
        html += '</tbody></table>';
        section.innerHTML = html;
      })
      .catch(function() {
        document.getElementById('pending-section').innerHTML = '<p class="msg err">Failed to load pending requests.</p>';
      });
  }

  var ALL_PROJECTS = ['health', 'shield', 'ego-assessment', 'mindreader'];
  var PROJECT_LABELS = { health: 'Health', shield: 'Shield', 'ego-assessment': 'Ego', mindreader: 'Mind Reader' };
  var usersData = [];
  var healthUsers = {}; // email -> {id, opus_enabled}

  function loadUsers() {
    // Fetch health tracker users in parallel for opus badges
    fetch('https://health.pragmaticdharma.org/admin/api/users', { credentials: 'include' })
      .then(function(r) { return r.json(); })
      .then(function(users) {
        healthUsers = {};
        users.forEach(function(u) {
          if (u.email) healthUsers[u.email.toLowerCase()] = { id: u.id, opus_enabled: u.opus_enabled };
        });
      })
      .catch(function() { healthUsers = {}; })
      .finally(function() { renderUsers(); });

    fetch('/api/admin/users', { credentials: 'include' })
      .then(function(r) { return r.json(); })
      .then(function(data) {
        var section = document.getElementById('users-section');
        if (!data.users || data.users.length === 0) {
          section.innerHTML = '<p class="empty">No users.</p>';
          return;
        }
        usersData = data.users;
        renderUsers();
      })
      .catch(function() {
        document.getElementById('users-section').innerHTML = '<p class="msg err">Failed to load users.</p>';
      });
  }

  function renderUsers() {
    if (!usersData.length) return;
    var section = document.getElementById('users-section');
    var html = '<table><thead><tr><th>Name</th><th>Email</th><th>Status</th><th>Role</th><th>Projects</th><th>Date</th></tr></thead><tbody>';
    usersData.forEach(function(u, idx) {
      var badges = '';
      ALL_PROJECTS.forEach(function(p) {
        var active = u.projects && u.projects.indexOf(p) !== -1;
        badges += '<span class="project-badge ' + (active ? 'active' : 'inactive') + '" data-user-idx="' + idx + '" data-project="' + esc(p) + '" onclick="toggleProject(this)">' + esc(PROJECT_LABELS[p] || p) + '</span>';
      });
      // Opus badge (from health tracker)
      var hu = healthUsers[(u.email || '').toLowerCase()];
      if (hu) {
        var opusActive = hu.opus_enabled ? 'active' : 'inactive';
        badges += '<span class="project-badge ' + opusActive + '" data-health-user-id="' + esc(hu.id) + '" onclick="toggleOpusHealth(this)" title="Opus model access (Health Tracker)">Opus</span>';
      }
      html += '<tr>'
        + '<td>' + esc(u.name) + '</td>'
        + '<td>' + esc(u.email) + '</td>'
        + '<td><span class="status-badge ' + esc(u.status) + '">' + esc(u.status) + '</span></td>'
        + '<td>' + esc(u.role || 'user') + '</td>'
        + '<td><div class="project-badges">' + badges + '</div></td>'
        + '<td>' + formatDate(u.created_at) + '</td>'
        + '</tr>';
    });
    html += '</tbody></table>';
    section.innerHTML = html;
  }

  window.toggleProject = function(badge) {
    var idx = parseInt(badge.getAttribute('data-user-idx'));
    var project = badge.getAttribute('data-project');
    var user = usersData[idx];
    if (!user || !user.id) return;

    // Toggle in local state
    var projects = (user.projects || []).slice();
    var i = projects.indexOf(project);
    if (i !== -1) { projects.splice(i, 1); } else { projects.push(project); }

    badge.classList.add('saving');
    fetch('/api/admin/user-projects', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ user_id: user.id, projects: projects }),
      credentials: 'include'
    })
    .then(function(r) { return r.json(); })
    .then(function(res) {
      badge.classList.remove('saving');
      if (res.ok) {
        user.projects = res.projects;
        // Update badge visuals
        var row = badge.parentElement;
        if (row) {
          var badges = row.querySelectorAll('.project-badge');
          badges.forEach(function(b) {
            var p = b.getAttribute('data-project');
            if (res.projects.indexOf(p) !== -1) {
              b.className = 'project-badge active';
            } else {
              b.className = 'project-badge inactive';
            }
          });
        }
      }
    })
    .catch(function() { badge.classList.remove('saving'); });
  };

  window.toggleOpusHealth = function(badge) {
    var userId = badge.getAttribute('data-health-user-id');
    if (!userId) return;
    var enabling = badge.classList.contains('inactive');
    badge.classList.add('saving');
    fetch('https://health.pragmaticdharma.org/admin/api/users/' + userId + '/opus', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ enabled: enabling }),
      credentials: 'include'
    })
    .then(function(r) { return r.json(); })
    .then(function(res) {
      badge.classList.remove('saving');
      if (res.success) {
        badge.className = 'project-badge ' + (res.opus_enabled ? 'active' : 'inactive');
        // Update local cache
        var email = Object.keys(healthUsers).find(function(e) { return healthUsers[e].id === userId; });
        if (email) healthUsers[email].opus_enabled = res.opus_enabled;
      }
    })
    .catch(function() { badge.classList.remove('saving'); });
  };

  window.createUser = function() {
    var name = document.getElementById('add-name').value.trim();
    var email = document.getElementById('add-email').value.trim();
    var fb = document.getElementById('add-feedback');
    fb.textContent = '';
    if (!name || !email) { fb.textContent = 'Name and email required.'; fb.className = 'msg err'; return; }

    fetch('/api/admin/create-user', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name: name, email: email }),
      credentials: 'include'
    })
    .then(function(r) { return r.json().then(function(d) { return { ok: r.ok, data: d }; }); })
    .then(function(res) {
      if (res.ok) {
        fb.textContent = email + ' added.';
        fb.className = 'msg ok';
        document.getElementById('add-name').value = '';
        document.getElementById('add-email').value = '';
        loadUsers();
      } else {
        fb.textContent = res.data.error || 'Failed to add user.';
        fb.className = 'msg err';
      }
    })
    .catch(function() { fb.textContent = 'Network error.'; fb.className = 'msg err'; });
  };

  window.doAction = function(action, email, btn) {
    btn.disabled = true;
    var feedback = document.getElementById('feedback');
    feedback.textContent = '';

    fetch('/api/admin/' + action, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email: email }),
      credentials: 'include'
    })
    .then(function(r) { return r.json().then(function(d) { return { ok: r.ok, data: d }; }); })
    .then(function(res) {
      if (res.ok) {
        feedback.textContent = email + ' ' + action + 'd.';
        feedback.className = 'msg ok';
        loadPending();
        loadUsers();
      } else {
        feedback.textContent = res.data.error || 'Action failed.';
        feedback.className = 'msg err';
        btn.disabled = false;
      }
    })
    .catch(function() {
      feedback.textContent = 'Network error.';
      feedback.className = 'msg err';
      btn.disabled = false;
    });
  };

  function esc(s) {
    var d = document.createElement('div');
    d.textContent = s;
    return d.innerHTML;
  }

  function formatDate(iso) {
    if (!iso) return '-';
    var d = new Date(iso);
    return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
  }
})();
</script>
</body>
</html>
